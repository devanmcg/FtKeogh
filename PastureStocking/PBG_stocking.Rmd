---
title: "Draft Ft Keogh stocking for patch-burning research"
author: "DAM"
date: "Version `r Sys.Date()`"
---

```{r setup, echo= FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
pacman::p_load(tidyverse, sf)
pacman::p_load_gh('devanmcg/wesanderson')
source('https://raw.githubusercontent.com/devanmcg/rangeR/master/R/CustomGGplotThemes.R')
```

```{r data, echo=FALSE}
ftk_sf <- read_sf('../SpatialData/boundary', 
                  'boundary_ftkeogh_LL') %>% 
  st_transform(26913) 

prod_d <- 
  readxl::read_xlsx('../PastureStocking/RangeProd.xlsx', 
                    'SSURGO') %>%
  select(musym, compname, rsprod_l, rsprod_r, rsprod_h) %>%
  rename(low = rsprod_l, 
         norm = rsprod_r, 
         high = rsprod_h)
  
es_sf <-
  read_sf('../SpatialData/soils/eco_sites', 
            'ftk_es') %>%
  rename(musym = MUSYM) %>%
  select(-MUKEY)

 es_prod <- left_join(es_sf, prod_d)

pastures <- 
  read_sf('../SpatialData/pastures', 
          'pastures') 

pbg <- 
  pastures %>% 
    filter(pasture %in% c('Upper Coal Creek', '2a North', '2a South', '3 Pasture',
                          'Sandridge North Native', 'Sandridge South Native', 
                          "Moon Creek", "Upper Lignite Creek", 'North 4', 'South 4')) %>%
    mutate(unit = case_when(
      pasture %in% c("North 4", "South 4") ~ "4 pastures", 
      pasture %in% c('Sandridge North Native', 'Sandridge South Native')  ~ "Sandridge", 
      #pasture %in% c('2a North', '2a South') ~ '2A', 
      TRUE ~ pasture), 
      pasture = case_when(
      pasture %in% c("North 4", "South 4") ~  paste(substr(pasture, 1,1), "4"),
      pasture %in% c('Sandridge North Native', 'Sandridge South Native')  ~ str_remove_all(pasture, " Native"), 
      #pasture %in% c('2a North', '2a South') ~ '2A', 
      TRUE ~ pasture), 
      group = case_when(
        substr(pasture, 1,5) == 'Upper' ~ "manage", 
        TRUE ~ 'study'  )) %>%
  mutate(area = st_area(.)) %>%
  group_by(group, pasture) %>%
  summarise(area = sum(area))

pbg_prod <- st_intersection(pbg, es_prod)
```

# Baseline productivity

This section just reviews forage productivity and recommended stocking rates for pastures along the southern boundary of Fort Keogh. 

```{r acres_tab}
pbg_prod %>%
  mutate(acres = as.numeric(st_area(.) * 0.0002471054) ) %>%
  as_tibble() %>%
  group_by(pasture) %>%
  summarize(Acres = sum(acres)) %>%
  arrange(desc(Acres)) %>%
  pander::pander("Area (acreage) of candidate patch-burning pastures. ")
  
```

Productivity data from SSURGO Rangeland Productivity: 

```{r overall_map, echo = FALSE}
ggplot() + theme_map(14) + 
  geom_sf(data = pbg_prod, 
          aes (fill = norm/1000),
          color = NA,
          show.legend = TRUE) +  
  geom_sf(data = pastures, 
          fill = NA, 
          color = 'grey70')  + 
  geom_sf(data = pbg, 
          fill = NA, 
          color = 'white')  + 
  geom_sf_text(data = pbg, 
               aes (label = pasture), 
               fontface= 'bold',
               show.legend = FALSE) + 
  geom_sf(data = ftk_sf, 
          fill = NA, 
          color = "black") +
  scale_fill_gradientn("Normal\nforage\nproduction\n(t/ac)", colors= wes_palette("Zissou1"))
```

Stocking rate calculations follow the [MT NRCS stocking guide](https://www.nrcs.usda.gov/Internet/FSE_DOCUMENTS/nrcs144p2_054048.pdf). 

$$
1~AUM = 915~lbs = 30~lb~d^{-1}~\times30~d
$$
```{r efficiency_factor}
eff = 0.25
```

Then multiplied by an efficiency factor, `r eff`.

```{r AUMs, echo=FALSE}
pbg_prod %>%
    mutate(acres = as.numeric(st_area(.) * 0.0002471054), 
         across(c(low, norm, high), ~ . * acres) ) %>%
  pivot_longer(names_to = "scenario", 
               values_to = "t_ac", 
               cols = c('low', 'norm', 'high')) %>%
  filter(!is.na(t_ac)) %>% 
  group_by(scenario, pasture) %>%
  summarize(productivity = sum(t_ac), 
            .groups = 'drop') %>%
  mutate(AUMs_50 = (productivity*eff)/915) %>%
  as_tibble() %>%
  select(-geometry, -productivity) %>%
  mutate(scenario = factor(scenario, levels =c ("low", "norm", "high"))) %>%
  pivot_wider(names_from = scenario, 
              values_from = AUMs_50) %>%
  arrange(desc(norm)) %>%
  pander::pander("Available AUMs by candidate patch-burn pasture under three precipitation scenarios.") 
```


So if a grazing season is to last 5 mo, the following number of cows would be assigned to each pasture:
*First, script to calculate stocking rate*

```{r stocking_rate, echo=TRUE}
pbg_prod %>%
    mutate(acres = as.numeric(st_area(.) * 0.0002471054), # sq. m. to acres
         across(c(low, norm, high), ~ . * acres) ) %>%    # per-acre production x acreage
  pivot_longer(names_to = "scenario", 
               values_to = "t_ac", 
               cols = c('low', 'norm', 'high')) %>%
  filter(!is.na(t_ac)) %>% 
  group_by(scenario, pasture) %>%
  summarize(productivity = sum(t_ac),           # total productivity for each unit
            .groups = 'drop') %>%
  mutate(pairs = ((productivity*eff)/915)/5,    # stocking for 5 mo; eff = efficiency factor
         pairs = round(pairs, 0)) %>%
  as_tibble() %>%
  select(-geometry, -productivity) %>%
  pivot_wider(names_from = scenario, 
              values_from = pairs) %>%
  arrange(desc(norm)) %>%
  pander::pander("Number of cow-calf pairs to stock for 5 mo at 50% forage consumption under three precipitation scenarios.") 
```

# Potential study designs

The proposed patch-burning study will compare two different fire regimes: 

* *4-yr fire return interval* in which 1/4 of each pasture is burned every year.  
* *8-y fire return interval* in which 1/4 of each pasture is burned every other year.

Grazing within each is discussed below.

Given the variability of pasture sizes in the candidate set and non-study needs for grazing availability, the candidate patch-burning pastures are classified into two categories: 

* *Study pastures* in which the timing, duration, and number of grazing animals are regulated
* *Adaptive management pastures* in which patches are burned according to a fire management plan and grazing worked into as necessary


## Study pastures

8 smaller to mid-size pastures selected for research in what could formally be called a patch-burn grazing study, in that fire and grazing regimes will both be experimentally manipulated. 

In addition to the two fire regimes (4-yr and 8-yr fire return intervals), two grazing regimes will be applied: 

* *Annual grazing* in which each pasture will be stocked in every year of the study
* *Biennial grazing* in which each pasture will only be grazed every other year


```{r study_map, echo = FALSE}
study <-
  pbg %>%
    filter(group == 'study') %>%
    mutate(trt = case_when(
      pasture %in% c('Moon Creek', 'N 4') ~ "8 yr, Biennial", 
      pasture %in% c('3 Pasture', 'S 4' ) ~ "4 yr, Biennial",
      pasture %in% c('2a North', 'Sandridge North') ~ "8 yr, Annual", 
      pasture %in% c('2a South', 'Sandridge South') ~ "4 yr, Annual"
    ))

ggplot() + theme_map(14) + 

  geom_sf(data = pastures, 
          fill = NA, 
          color = 'grey70')  + 
  geom_sf(data = study, 
          aes(fill = trt), 
          color = 'white',
               show.legend = TRUE)  + 
  geom_sf_text(data = study,  
               aes (label = pasture), 
               fontface= 'bold') + 
  geom_sf(data = ftk_sf, 
          fill = NA, 
          color = "black") +
  scale_fill_manual("Treatment\n(FRI, grazing)", values= wes_palette("Zissou1")[1:4])
```

### Ecological sites 

```{r site_map, fig.caption = "Three most extensive ecological sites by study pasture."}
study_sites <-
  pbg_prod %>%
  filter(group == 'study', 
         ! site %in% c('None', 'none')) %>%
  mutate(acres = as.numeric(st_area(.) * 0.0002471054), 
         trt = case_when(
                  pasture %in% c('Moon Creek', 'N 4') ~ "8 yr, Biennial", 
                  pasture %in% c('3 Pasture', 'S 4' ) ~ "4 yr, Biennial",
                  pasture %in% c('2a North', 'Sandridge North') ~ "8 yr, Annual", 
                  pasture %in% c('2a South', 'Sandridge South') ~ "4 yr, Annual"
  )) %>%
  group_by(pasture, site) %>%
  summarize(acres = sum(acres)) %>%
  arrange(pasture, desc(acres)) %>%
  slice(1:3)

ggplot() + theme_map(14) + 
  geom_sf(data = study_sites, 
          aes(fill = site), 
          color = 'white',
          show.legend = TRUE)  + 
  geom_sf(data = study,  
                fill = NA,
               color = "black") + 
  # geom_sf_text(data = study,  
  #              aes (label = pasture), 
  #              fontface= 'bold') + 
  scale_fill_manual("Ecological site", values= wes_palette("Zissou1"))
```

All pastures have a substantial area of silty-steep ecological sites. 
All pastures have silty or sandy sites. 

```{r site_tab}
study_sites %>%
  as_tibble() %>%
  select(pasture, site, acres) %>%
 # mutate(acres = replace_na(acres, " ")) %>%
  pivot_wider(names_from = site, 
              values_from = acres) %>%
  pander::pander("Acreage of three most extensive ecological sites by pasture.") 
```
## Management pastures 

These pastures ought to have a fire management plan but likely cannot have grazing regulated enough to be included in a formal experiment. 
They are also huge (an order of magnitude larger area than study pastures). 
As such, I propose the same fire regimes (4-yr and 8-yr return intervals) on 1/4 of the total area, but divided between two fire seasons (1/8 in fall, 1/8 in spring). 

```{r manage_map}
ggplot() + theme_map(14) + 

  geom_sf(data = pastures, 
          fill = NA, 
          color = 'grey70')  + 
  geom_sf(data = filter(pbg, group == "manage"), 
          fill = wes_palette("Zissou1")[5], 
          color = 'white',
        alpha = 0.6)  + 
  geom_sf_text(data = filter(pbg, group == "manage"),   
               aes (label = pasture), 
               fontface= 'bold') + 
  geom_sf(data = ftk_sf, 
          fill = NA, 
          color = "black")
```

